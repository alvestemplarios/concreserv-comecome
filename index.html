<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CONCRESERV COME-COME ‚Äî ALVES GAMES</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00eaff">

<!-- iPhone -->
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<style>
body {
  margin: 0;
  background: radial-gradient(circle at top, #111, #000);
  font-family: Arial, Helvetica, sans-serif;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  user-select: none;
  touch-action: none;
}

h1 {
  margin-top: 15px;
  font-size: 28px;
  text-shadow: 0 0 10px #00eaff, 0 0 20px #ff00ff;
}

#subTitle {
  font-size: 14px;
  opacity: 0.8;
  margin-bottom: 10px;
}

canvas {
  border: 5px solid #00eaff;
  box-shadow: 0 0 25px #00eaff, 0 0 35px #ff00ff;
  background: #000;
}

#menuOverlay {
  position: absolute;
  inset: 0;
  background: #000000dd;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 5;
}

.neon-btn {
  padding: 10px 22px;
  margin: 6px;
  border-radius: 25px;
  background: transparent;
  border: 2px solid #00eaff;
  color: #fff;
  cursor: pointer;
  box-shadow: 0 0 15px #00eaff;
  text-transform: uppercase;
}

#levelOverlay {
  position: absolute;
  inset: 0;
  background: #000000ee;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 4;
}

#truckFace {
  width: 150px;
  margin-bottom: 10px;
  box-shadow: 0 0 20px #00eaff;
}

#hud {
  margin-top: 10px;
  display: flex;
  gap: 20px;
}

#footerBrand {
  margin-top: 15px;
  font-size: 14px;
  letter-spacing: 1px;
  text-shadow: 0 0 8px #00eaff;
}

/* JOYSTICK FLUTUANTE */
#joystickWrapper {
  position: fixed;
  width: 140px;
  height: 140px;
  display: none;
  pointer-events: none;
  z-index: 99;
}

#joyBase {
  position: absolute;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  border: 2px solid #00eaff;
  background: radial-gradient(circle, rgba(0,234,255,0.15), rgba(0,0,0,0.85));
  box-shadow: 0 0 20px #00eaff88;
}

#joyStick {
  position: absolute;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: radial-gradient(circle, #00eaff, #004a66);
  box-shadow: 0 0 12px #00eaff, 0 0 20px #00eaffaa;
  left: 40px;
  top: 40px;
}

@media (max-width: 700px) {
  canvas {
    transform: scale(0.85);
    transform-origin: top center;
  }
}
</style>
</head>

<body>

<h1>CONCRESERV COME-COME</h1>
<div id="subTitle">Vers√£o Web / Mobile ‚Äî Caminh√£o Come Blocos de Concreto</div>

<div style="position:relative;">
  <canvas id="game" width="608" height="480"></canvas>

  <div id="menuOverlay">
    <div style="font-size:26px;margin-bottom:10px;">üéÆ CONCRESERV RETRO NEON</div>
    <button class="neon-btn" id="startBtn">COME√áAR</button>
    <button class="neon-btn" id="modeBtn">REAL</button>
    <h3>Ranking</h3>
    <ol id="rankingList"></ol>
  </div>

  <div id="levelOverlay">
    <img src="truck_face.png" id="truckFace" alt="CONCRESERV">
    <div id="levelTitle">FASE CONCLU√çDA!</div>
    <div id="levelMsg"></div>
  </div>
</div>

<div id="hud">
  <div>Fase: <span id="levelValue">1</span></div>
  <div>Pontos: <span id="scoreValue">0</span></div>
  <div>Melhor: <span id="bestValue">0</span></div>
</div>

<!-- JOYSTICK FLUTUANTE -->
<div id="joystickWrapper">
  <div id="joyBase"></div>
  <div id="joyStick"></div>
</div>

<div id="footerBrand">ALVES GAMES / CONCRESERV EDITION ‚Äî 2025</div>

<script>
/* ============================================================
   √ÅUDIO
   ============================================================ */
const sndEat     = new Audio("eat.wav");
const sndDeath   = new Audio("death.wav");
const sndVictory = new Audio("victory.wav");
const sndMove    = new Audio("move.wav");

function playSound(snd){
  snd.currentTime = 0;
  snd.play().catch(()=>{});
}

/* ============================================================
   CANVAS / DOM
   ============================================================ */
const canvas = document.getElementById("game");
const ctx    = canvas.getContext("2d");

const menuOverlay = document.getElementById("menuOverlay");
const startBtn    = document.getElementById("startBtn");
const modeBtn     = document.getElementById("modeBtn");
const rankingList = document.getElementById("rankingList");

const levelOverlay = document.getElementById("levelOverlay");
const levelMsg     = document.getElementById("levelMsg");

const scoreSpan = document.getElementById("scoreValue");
const bestSpan  = document.getElementById("bestValue");
const levelSpan = document.getElementById("levelValue");

/* JOYSTICK ELEMENTOS */
const joystickWrapper = document.getElementById("joystickWrapper");
const joyBase = document.getElementById("joyBase");
const joyStick = document.getElementById("joyStick");

let joyActive = false;
let joyStartX = 0;
let joyStartY = 0;

const JOY_SIZE = 140;
const KNOB_SIZE = 60;
const JOY_CENTER = (JOY_SIZE - KNOB_SIZE)/2;
const MAX_DIST = JOY_CENTER;

function centerKnob(){
  joyStick.style.left = JOY_CENTER + "px";
  joyStick.style.top  = JOY_CENTER + "px";
}

/* TOUCH START */
canvas.addEventListener("touchstart",(e)=>{
  const t = e.touches[0];

  joyActive = true;
  joyStartX = t.clientX;
  joyStartY = t.clientY;

  joystickWrapper.style.left = (joyStartX - JOY_SIZE/2) + "px";
  joystickWrapper.style.top  = (joyStartY - JOY_SIZE/2) + "px";
  joystickWrapper.style.display = "block";

  centerKnob();
});

/* TOUCH MOVE */
canvas.addEventListener("touchmove",(e)=>{
  if (!joyActive) return;

  const t = e.touches[0];
  handleJoystickMove(t.clientX, t.clientY);
});

/* TOUCH END */
canvas.addEventListener("touchend",()=>{
  joyActive = false;
  joystickWrapper.style.display="none";
  centerKnob();
});

/* JOYSTICK L√ìGICA */
function handleJoystickMove(clientX, clientY){
  let dx = clientX - joyStartX;
  let dy = clientY - joyStartY;

  let dist = Math.hypot(dx, dy);
  if (dist > MAX_DIST){
    const ratio = MAX_DIST / dist;
    dx *= ratio;
    dy *= ratio;
  }

  joyStick.style.left = (JOY_CENTER + dx) + "px";
  joyStick.style.top  = (JOY_CENTER + dy) + "px";

  const dead = 10;
  if (Math.abs(dx) < dead && Math.abs(dy) < dead) return;

  if (Math.abs(dx) > Math.abs(dy)){
    if (dx > 0) setDirection(1, 0);
    else        setDirection(-1, 0);
  } else {
    if (dy > 0) setDirection(0, 1);
    else        setDirection(0, -1);
  }
}

/* ============================================================
   PLAYER
   ============================================================ */
const tileSize = 32;

const truck = {
  x:1, y:1,
  dirX:1, dirY:0,
  nextDirX:1, nextDirY:0,
  offsetX:0, offsetY:0,
  speed:0.04
};

function setDirection(dx,dy){
  truck.nextDirX = dx;
  truck.nextDirY = dy;
  playSound(sndMove);
}

/* ============================================================
   FANTASMAS
   ============================================================ */
const ghosts = [];

function createGhost(x,y,img,speed){
  return {x,y,dirX:0,dirY:1,offsetX:0,offsetY:0,img,speed};
}

function resetGhosts(){
  ghosts.length = 0;
  ghosts.push(createGhost( 9,7, ghostRedImg,    0.035));
  ghosts.push(createGhost(10,7, ghostPinkImg,   0.033));
  ghosts.push(createGhost( 8,7, ghostBlueImg,   0.030));
  ghosts.push(createGhost(11,7, ghostOrangeImg, 0.028));
}

/* ============================================================
   LABIRINTO
   ============================================================ */
const baseMaze = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1],
  [1,0,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1],
  [1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,1],
  [1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1],
  [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1],
  [1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1],
  [1,0,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

let maze = [];
let pellets = [];

/* ============================================================
   SPRITES
   ============================================================ */
const truckRealImg  = new Image(); truckRealImg.src  = "truck_real.png";
const truckPixelImg = new Image(); truckPixelImg.src = "truck_pixel.png";
const truckUpImg    = new Image(); truckUpImg.src    = "truck_up.png";
const truckDownImg  = new Image(); truckDownImg.src  = "truck_down.png";

const ghostRedImg    = new Image(); ghostRedImg.src    = "ghost_red.png";
const ghostBlueImg   = new Image(); ghostBlueImg.src   = "ghost_blue.png";
const ghostPinkImg   = new Image(); ghostPinkImg.src   = "ghost_pink.png";
const ghostOrangeImg = new Image(); ghostOrangeImg.src = "ghost_orange.png";

let spriteMode = "real";

/* ============================================================
   GAME LOGIC
   ============================================================ */
function setupLevel(){
  maze = baseMaze.map(r=>r.slice());
  pellets = maze.map(r=>r.map(c=>c===0));
  resetGhosts();
  resetTruck();
}

function resetTruck(){
  truck.x = 1;
  truck.y = 1;

  truck.dirX = 1;
  truck.dirY = 0;

  truck.nextDirX = 1;
  truck.nextDirY = 0;

  truck.offsetX = 0;
  truck.offsetY = 0;
}

function setDirection(dx, dy){
  truck.nextDirX = dx;
  truck.nextDirY = dy;
  playSound(sndMove);
}

/* ---------- MOVIMENTO DO TRUCK ---------- */
function updateTruck(){
  if (truck.offsetX === 0 && truck.offsetY === 0){
    const tx = truck.x + truck.nextDirX;
    const ty = truck.y + truck.nextDirY;

    if (maze[ty] && maze[ty][tx] === 0){
      truck.dirX = truck.nextDirX;
      truck.dirY = truck.nextDirY;
    }
  }

  truck.offsetX += truck.dirX * truck.speed;
  truck.offsetY += truck.dirY * truck.speed;

  if (Math.abs(truck.offsetX) >= 1 || Math.abs(truck.offsetY) >= 1){
    const nx = truck.x + Math.sign(truck.offsetX);
    const ny = truck.y + Math.sign(truck.offsetY);

    if (maze[ny] && maze[ny][nx] === 0){
      truck.x = nx;
      truck.y = ny;
    }

    truck.offsetX = 0;
    truck.offsetY = 0;
  }

  if (pellets[truck.y][truck.x]){
    pellets[truck.y][truck.x] = false;
    score += 10;
    scoreSpan.textContent = score;
    playSound(sndEat);
  }
}

/* ---------- FANTASMAS ---------- */
function updateGhost(g){
  if (g.offsetX === 0 && g.offsetY === 0){
    const dirs = [
      {x:1, y:0}, {x:-1, y:0},
      {x:0, y:1}, {x:0, y:-1}
    ];

    const opts = dirs.filter(d =>
      maze[g.y + d.y] && maze[g.y + d.y][g.x + d.x] === 0
    );

    if (opts.length > 0){
      const c = opts[Math.floor(Math.random() * opts.length)];
      g.dirX = c.x;
      g.dirY = c.y;
    }
  }

  g.offsetX += g.dirX * g.speed;
  g.offsetY += g.dirY * g.speed;

  if (Math.abs(g.offsetX) >= 1 || Math.abs(g.offsetY) >= 1){
    const nx = g.x + Math.sign(g.offsetX);
    const ny = g.y + Math.sign(g.offsetY);

    if (maze[ny] && maze[ny][nx] === 0){
      g.x = nx;
      g.y = ny;
    }

    g.offsetX = 0;
    g.offsetY = 0;
  }
}

/* ---------- COLIS√ïES ---------- */
function checkCollisions(){
  const cx = (truck.x + truck.offsetX)*tileSize + 16;
  const cy = (truck.y + truck.offsetY)*tileSize + 16;

  for (const g of ghosts){
    const gx = (g.x + g.offsetX)*tileSize + 16;
    const gy = (g.y + g.offsetY)*tileSize + 16;
    const dist = Math.hypot(cx - gx, cy - gy);

    if (dist < 22){
      gameOver();
      return;
    }
  }

  const anyPellet = pellets.flat().some(v => v);
  if (!anyPellet && gameState === "playing") levelCompleted();
}

/* ============================================================
   DESENHO
   ============================================================ */

function drawMaze(){
  for (let y = 0; y < maze.length; y++){
    for (let x = 0; x < maze[0].length; x++){
      const px = x*tileSize;
      const py = y*tileSize;

      if (maze[y][x] === 1){
        ctx.fillStyle="#05071A";
        ctx.fillRect(px, py, tileSize, tileSize);
        ctx.strokeStyle="#00eaff";
        ctx.strokeRect(px+3, py+3, tileSize-6, tileSize-6);
      } else {
        ctx.fillStyle="#000";
        ctx.fillRect(px, py, tileSize, tileSize);

        if (pellets[y][x]){
          ctx.fillStyle="#ffcc66";
          ctx.fillRect(px+12, py+14, 8, 4);
        }
      }
    }
  }
}

function drawTruck(){
  const cx = (truck.x + truck.offsetX)*tileSize + 16;
  const cy = (truck.y + truck.offsetY)*tileSize + 16;

  const w = tileSize*2;
  const h = tileSize*1.1;

  let img;
  if (truck.dirY === -1) img = truckUpImg;
  else if (truck.dirY === 1) img = truckDownImg;
  else img = spriteMode === "real" ? truckRealImg : truckPixelImg;

  ctx.save();
  ctx.translate(cx, cy);
  if (truck.dirX === 1 && truck.dirY === 0) ctx.scale(-1, 1);
  ctx.drawImage(img, -w/2, -h/2, w, h);
  ctx.restore();
}

function drawGhost(g){
  const cx = (g.x + g.offsetX)*tileSize + 16;
  const cy = (g.y + g.offsetY)*tileSize + 16;
  ctx.drawImage(g.img, cx-20, cy-20, 48, 28);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMaze();
  drawTruck();
  ghosts.forEach(drawGhost);
}

/* ============================================================
   LOOP
   ============================================================ */
let gameState = "menu";

function loop(){
  if (gameState === "playing"){
    updateTruck();
    ghosts.forEach(updateGhost);
    checkCollisions();
  }
  draw();
  requestAnimationFrame(loop);
}

/* ============================================================
   N√çVEIS
   ============================================================ */
function levelCompleted(){
  playSound(sndVictory);
  saveScore(score);

  levelMsg.textContent = `Voc√™ concluiu a fase ${currentLevel}! Pontos: ${score}`;
  levelOverlay.style.display = "flex";

  currentLevel++;
  levelSpan.textContent = currentLevel;

  setTimeout(()=>{
    levelOverlay.style.display = "none";
    setupLevel();
    gameState = "playing";
  }, 1500);
}

function gameOver(){
  playSound(sndDeath);
  saveScore(score);

  gameState = "menu";
  menuOverlay.style.display = "flex";
  startBtn.textContent = "JOGAR NOVO";
}

/* ============================================================
   START
   ============================================================ */
startBtn.addEventListener("click", ()=>{
  score = 0;
  currentLevel = 1;
  scoreSpan.textContent = score;
  levelSpan.textContent = currentLevel;

  setupLevel();
  menuOverlay.style.display = "none";
  gameState = "playing";
});

modeBtn.addEventListener("click", ()=>{
  spriteMode = spriteMode === "real" ? "pixel" : "real";
  modeBtn.textContent = spriteMode.toUpperCase();
});

/* ============================================================
   RANKING
   ============================================================ */
const SCORE_KEY = "concreserv_scores";

function loadScores(){
  try { return JSON.parse(localStorage.getItem(SCORE_KEY)) || []; }
  catch { return []; }
}

function saveScore(s){
  const arr = loadScores();
  arr.push(s);
  arr.sort((a,b)=>b-a);
  localStorage.setItem(SCORE_KEY, JSON.stringify(arr.slice(0,5)));
  updateRanking();
}

function updateRanking(){
  const arr = loadScores();
  rankingList.innerHTML = "";

  arr.forEach((v,i)=>{
    const li = document.createElement("li");
    li.textContent = `${i+1}¬∫ - ${v} pts`;
    rankingList.appendChild(li);
  });

  bestSpan.textContent = arr[0] || 0;
}

updateRanking();

/* ============================================================
   SERVICE WORKER
   ============================================================ */
if ("serviceWorker" in navigator){
  navigator.serviceWorker.register("./service-worker.js")
    .then(()=>console.log("SW registrado"))
    .catch(err=>console.log("SW erro:", err));
}

/* ============================================================
   INICIAR LOOP
   ============================================================ */
setupLevel();
loop();
</script>

</body>
</html>
