<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CONCRESERV COME-COME ‚Äî ALVES GAMES</title>

<style>
body {
  margin: 0;
  background: radial-gradient(circle at top, #111, #000);
  font-family: Arial, Helvetica, sans-serif;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  user-select: none;
  touch-action: none;
}

h1 {
  margin-top: 15px;
  font-size: 28px;
  text-shadow: 0 0 10px #00eaff, 0 0 20px #ff00ff;
}

#subTitle {
  font-size: 14px;
  opacity: 0.8;
  margin-bottom: 10px;
}

canvas {
  border: 5px solid #00eaff;
  box-shadow: 0 0 25px #00eaff, 0 0 35px #ff00ff;
  background: #000;
}

/* MENU */
#menuOverlay {
  position: absolute;
  inset: 0;
  background: #000000dd;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 5;
}

.neon-btn {
  padding: 10px 22px;
  margin: 6px;
  border-radius: 25px;
  background: transparent;
  border: 2px solid #00eaff;
  color: #fff;
  cursor: pointer;
  box-shadow: 0 0 15px #00eaff;
  text-transform: uppercase;
}

#rankingList {
  list-style: none;
  padding-left: 15px;
}

/* LEVEL OVERLAY */
#levelOverlay {
  position: absolute;
  inset: 0;
  background: #000000ee;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 4;
}

#truckFace {
  width: 150px;
  margin-bottom: 10px;
  box-shadow: 0 0 20px #00eaff;
}

#levelTitle {
  font-size: 22px;
  margin-bottom: 10px;
}

/* HUD */
#hud {
  margin-top: 10px;
  display: flex;
  gap: 20px;
}

/* FOOTER */
#footerBrand {
  margin-top: 15px;
  font-size: 14px;
  letter-spacing: 1px;
  text-shadow: 0 0 8px #00eaff;
}

/* JOYSTICK DIGITAL */
#joystickContainer {
  margin-top: 20px;
  display: none;
}

.jbtn {
  width: 60px;
  height: 60px;
  background: #111;
  border: 2px solid #00eaff;
  box-shadow: 0 0 12px #00eaff;
  margin: 5px;
  text-align: center;
  line-height: 60px;
  font-size: 26px;
  border-radius: 12px;
  user-select: none;
  cursor: pointer;
}

#joyGrid {
  display: grid;
  grid-template-columns: 60px 60px 60px;
}

/* MOBILE ESCALA */
@media (max-width: 700px) {
  canvas {
    transform: scale(0.85);
    transform-origin: top center;
  }
}
</style>
</head>

<body>

<h1>CONCRESERV COME-COME</h1>
<div id="subTitle">Vers√£o Web ‚Äî Caminh√£o Come Blocos de Concreto no labirinto neon</div>

<div style="position:relative;">
  <canvas id="game" width="608" height="480"></canvas>

  <!-- MENU -->
  <div id="menuOverlay">
    <div id="menuTitle" style="font-size:26px;margin-bottom:10px;">
      üéÆ CONCRESERV RETRO NEON
    </div>
    <button class="neon-btn" id="startBtn">COME√áAR</button>
    <button class="neon-btn" id="modeBtn">REAL</button>

    <h3>Ranking</h3>
    <ol id="rankingList"></ol>
  </div>

  <!-- LEVEL -->
  <div id="levelOverlay">
    <img src="img/truck_face.png" id="truckFace" alt="CONCRESERV">
    <div id="levelTitle">FASE CONCLU√çDA!</div>
    <div id="levelMsg"></div>
  </div>
</div>

<!-- HUD -->
<div id="hud">
  <div>Fase: <span id="levelValue">1</span></div>
  <div>Pontos: <span id="scoreValue">0</span></div>
  <div>Melhor: <span id="bestValue">0</span></div>
</div>

<!-- JOYSTICK DIGITAL -->
<div id="joystickContainer">
  <div id="joyGrid">
    <div></div>
    <div class="jbtn" id="btnUp">‚¨ÜÔ∏è</div>
    <div></div>
    <div class="jbtn" id="btnLeft">‚¨ÖÔ∏è</div>
    <div></div>
    <div class="jbtn" id="btnRight">‚û°Ô∏è</div>
    <div></div>
    <div class="jbtn" id="btnDown">‚¨áÔ∏è</div>
    <div></div>
  </div>
</div>

<div id="footerBrand">ALVES GAMES / CONCRESERV EDITION ‚Äî 2025</div>

<script>
/* ===== CANVAS E DOM ===== */
const canvas = document.getElementById("game");
const ctx    = canvas.getContext("2d");

const menuOverlay = document.getElementById("menuOverlay");
const menuTitle   = document.getElementById("menuTitle");
const startBtn    = document.getElementById("startBtn");
const modeBtn     = document.getElementById("modeBtn");
const rankingList = document.getElementById("rankingList");

const levelOverlay = document.getElementById("levelOverlay");
const levelMsg     = document.getElementById("levelMsg");

const scoreSpan = document.getElementById("scoreValue");
const bestSpan  = document.getElementById("bestValue");
const levelSpan = document.getElementById("levelValue");

const joystickContainer = document.getElementById("joystickContainer");
const btnUp    = document.getElementById("btnUp");
const btnDown  = document.getElementById("btnDown");
const btnLeft  = document.getElementById("btnLeft");
const btnRight = document.getElementById("btnRight");

/* ===== ESTADO ===== */
let gameState    = "menu";
let score        = 0;
let currentLevel = 1;
const tileSize   = 32;

/* ===== LABIRINTO ===== */
const baseMaze = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1],
  [1,0,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1],
  [1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,1],
  [1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1],
  [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1],
  [1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1],
  [1,0,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const rows = baseMaze.length;
const cols = baseMaze[0].length;

let maze    = [];
let pellets = [];

/* ===== SPRITES ===== */
const truckRealImg   = new Image(); // lateral (virado para a ESQUERDA)
const truckPixelImg  = new Image(); // lateral pixel (tamb√©m esquerda)
const truckUpImg     = new Image(); // frente
const truckDownImg   = new Image(); // traseira
const ghostRedImg    = new Image();
const ghostPinkImg   = new Image();
const ghostBlueImg   = new Image();
const ghostOrangeImg = new Image();

truckRealImg.src   = "img/truck_real.png";
truckPixelImg.src  = "img/truck_pixel.png";
truckUpImg.src     = "img/truck_up.png";
truckDownImg.src   = "img/truck_down.png";
ghostRedImg.src    = "img/ghost_red.png";
ghostPinkImg.src   = "img/ghost_pink.png";
ghostBlueImg.src   = "img/ghost_blue.png";
ghostOrangeImg.src = "img/ghost_orange.png";

let spriteMode = "real";

/* ===== PLAYER ===== */
const truck = {
  x: 1,
  y: 1,
  dirX: 1,
  dirY: 0,
  nextDirX: 1,
  nextDirY: 0,
  offsetX: 0,
  offsetY: 0,
  speed: 0.08
};

/* ===== FANTASMAS ===== */
const ghosts = [];

function createGhost(x, y, img, speed) {
  return { x, y, dirX: 0, dirY: 1, offsetX: 0, offsetY: 0, speed, img };
}

function resetGhosts() {
  ghosts.length = 0;
  ghosts.push(createGhost( 9, 7, ghostRedImg,    0.060));
  ghosts.push(createGhost(10, 7, ghostPinkImg,   0.055));
  ghosts.push(createGhost( 8, 7, ghostBlueImg,   0.050));
  ghosts.push(createGhost(11, 7, ghostOrangeImg, 0.048));
}

/* ===== RANKING ===== */
const SCORE_KEY = "concreserv_scores";

function loadScores() {
  try { return JSON.parse(localStorage.getItem(SCORE_KEY)) || []; }
  catch { return []; }
}

function saveScore(s) {
  const arr = loadScores();
  arr.push(s);
  arr.sort((a, b) => b - a);
  localStorage.setItem(SCORE_KEY, JSON.stringify(arr.slice(0, 5)));
  updateRanking();
}

function updateRanking() {
  const arr = loadScores();
  rankingList.innerHTML = "";
  arr.forEach((v, i) => {
    const li = document.createElement("li");
    li.textContent = `${i + 1}¬∫ - ${v} pts`;
    rankingList.appendChild(li);
  });
  bestSpan.textContent = arr[0] || 0;
}
updateRanking();

/* ===== CONTROLES ===== */
function setDirection(dx, dy) {
  truck.nextDirX = dx;
  truck.nextDirY = dy;
}

window.addEventListener("keydown", (e) => {
  if (e.key === "ArrowUp")    setDirection(0, -1);
  if (e.key === "ArrowDown")  setDirection(0,  1);
  if (e.key === "ArrowLeft")  setDirection(-1, 0);
  if (e.key === "ArrowRight") setDirection(1,  0);
});

btnUp.addEventListener("click",    () => setDirection(0, -1));
btnDown.addEventListener("click",  () => setDirection(0,  1));
btnLeft.addEventListener("click",  () => setDirection(-1, 0));
btnRight.addEventListener("click", () => setDirection(1,  0));

/* ===== START / MODE ===== */
startBtn.addEventListener("click", () => {
  score        = 0;
  currentLevel = 1;
  levelSpan.textContent = currentLevel;
  scoreSpan.textContent = score;

  setupLevel();
  joystickContainer.style.display = "block";
  menuOverlay.style.display       = "none";
  menuTitle.textContent           = "üéÆ CONCRESERV RETRO NEON";
  startBtn.textContent            = "COME√áAR";
  gameState = "playing";
});

modeBtn.addEventListener("click", () => {
  spriteMode = (spriteMode === "real") ? "pixel" : "real";
  modeBtn.textContent = spriteMode.toUpperCase();
});

/* ===== N√çVEIS ===== */
function setupLevel() {
  maze    = baseMaze.map(row => row.slice());
  pellets = maze.map(row => row.map(c => c === 0));
  resetGhosts();
  resetTruck();
}

function resetTruck() {
  truck.x = 1;
  truck.y = 1;
  truck.dirX = 1;
  truck.dirY = 0;
  truck.nextDirX = 1;
  truck.nextDirY = 0;
  truck.offsetX = 0;
  truck.offsetY = 0;
}

function levelCompleted() {
  saveScore(score);
  levelMsg.textContent =
    `Voc√™ concluiu a fase ${currentLevel}! Pontos: ${score}`;
  levelOverlay.style.display = "flex";

  currentLevel++;
  levelSpan.textContent = currentLevel;

  setTimeout(() => {
    levelOverlay.style.display = "none";
    setupLevel();
    gameState = "playing";
  }, 1500);
}

function gameOver() {
  saveScore(score);
  gameState = "menu";
  joystickContainer.style.display = "none";
  menuOverlay.style.display = "flex";
  menuTitle.textContent = "üíÄ GAME OVER";
  startBtn.textContent  = "JOGAR NOVO";
}

/* ===== UPDATE ===== */
function updateTruck() {
  if (truck.offsetX === 0 && truck.offsetY === 0) {
    const tx = truck.x + truck.nextDirX;
    const ty = truck.y + truck.nextDirY;
    if (maze[ty] && maze[ty][tx] === 0) {
      truck.dirX = truck.nextDirX;
      truck.dirY = truck.nextDirY;
    }
  }

  truck.offsetX += truck.dirX * truck.speed;
  truck.offsetY += truck.dirY * truck.speed;

  if (Math.abs(truck.offsetX) >= 1 || Math.abs(truck.offsetY) >= 1) {
    const nx = truck.x + Math.sign(truck.offsetX);
    const ny = truck.y + Math.sign(truck.offsetY);

    if (maze[ny] && maze[ny][nx] === 0) {
      truck.x = nx;
      truck.y = ny;
    }
    truck.offsetX = 0;
    truck.offsetY = 0;
  }

  if (pellets[truck.y][truck.x]) {
    pellets[truck.y][truck.x] = false;
    score += 10;
    scoreSpan.textContent = score;
  }
}

function updateGhost(g) {
  if (g.offsetX === 0 && g.offsetY === 0) {
    const dirs = [
      { x: 1,  y: 0 },
      { x:-1,  y: 0 },
      { x: 0,  y: 1 },
      { x: 0,  y:-1 }
    ];
    let opts = dirs.filter(d =>
      maze[g.y + d.y] && maze[g.y + d.y][g.x + d.x] === 0
    );
    if (opts.length > 0) {
      const c = opts[Math.floor(Math.random() * opts.length)];
      g.dirX = c.x;
      g.dirY = c.y;
    }
  }

  g.offsetX += g.dirX * g.speed;
  g.offsetY += g.dirY * g.speed;

  if (Math.abs(g.offsetX) >= 1 || Math.abs(g.offsetY) >= 1) {
    const nx = g.x + Math.sign(g.offsetX);
    const ny = g.y + Math.sign(g.offsetY);
    if (maze[ny] && maze[ny][nx] === 0) {
      g.x = nx;
      g.y = ny;
    }
    g.offsetX = 0;
    g.offsetY = 0;
  }
}

function checkCollisions() {
  const cx = (truck.x + truck.offsetX) * tileSize + 16;
  const cy = (truck.y + truck.offsetY) * tileSize + 16;

  for (const g of ghosts) {
    const gx = (g.x + g.offsetX) * tileSize + 16;
    const gy = (g.y + g.offsetY) * tileSize + 16;
    const dist = Math.hypot(cx - gx, cy - gy);
    if (dist < 22) {
      gameOver();
      return;
    }
  }

  const anyPellet = pellets.flat().some(v => v);
  if (!anyPellet && gameState === "playing") {
    levelCompleted();
  }
}

/* ===== DESENHO ===== */
function drawMaze() {
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      const px = x * tileSize;
      const py = y * tileSize;

      if (maze[y][x] === 1) {
        ctx.fillStyle = "#05071A";
        ctx.fillRect(px, py, tileSize, tileSize);
        ctx.strokeStyle = "#00eaff";
        ctx.lineWidth = 2;
        ctx.strokeRect(px + 3, py + 3, tileSize - 6, tileSize - 6);
      } else {
        ctx.fillStyle = "#000";
        ctx.fillRect(px, py, tileSize, tileSize);

        if (pellets[y][x]) {
          ctx.fillStyle = "#ffcc66";
          ctx.fillRect(px + 12, py + 14, 8, 4);
        }
      }
    }
  }
}

/* üéØ NOVA VERS√ÉO DO drawTruck ‚Äì sem rota√ß√£o maluca, s√≥ espelhamento */
function drawTruck() {
  const cx = (truck.x + truck.offsetX) * tileSize + 16;
  const cy = (truck.y + truck.offsetY) * tileSize + 16;
  const w  = tileSize * 2;
  const h  = tileSize * 1.1;

  let img;

  // CIMA / BAIXO usam sprites dedicadas, sem rota√ß√£o
  if (truck.dirY === -1) {
    img = truckUpImg;     // caminh√£o visto de frente
  } else if (truck.dirY === 1) {
    img = truckDownImg;   // caminh√£o visto de tr√°s
  } else {
    // ESQUERDA / DIREITA usam a sprite lateral
    img = (spriteMode === "real") ? truckRealImg : truckPixelImg;
  }

  ctx.save();
  ctx.translate(cx, cy);

  // IMPORTANTE:
  // - A sprite lateral est√° virada para a ESQUERDA (cabine para a esquerda).
  // - Ent√£o:
  //   -> dirX === -1 (indo para a esquerda): usa imagem normal
  //   -> dirX ===  1 (indo para a direita): espelha horizontalmente
  if (truck.dirY === 0) {
    if (truck.dirX === 1) {
      ctx.scale(-1, 1); // espelha na horizontal para ir pra direita
    }
    // se dirX === -1, n√£o faz nada (j√° est√° voltada para a esquerda)
  }

  ctx.drawImage(img, -w / 2, -h / 2, w, h);
  ctx.restore();
}

function drawGhost(g) {
  const cx = (g.x + g.offsetX) * tileSize + 16;
  const cy = (g.y + g.offsetY) * tileSize + 16;
  const w  = tileSize * 1.6;
  const h  = tileSize * 1.1;
  ctx.drawImage(g.img, cx - w / 2, cy - h / 2, w, h);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawMaze();
  drawTruck();
  ghosts.forEach(drawGhost);
}

/* ===== LOOP ===== */
function loop() {
  if (gameState === "playing") {
    updateTruck();
    ghosts.forEach(updateGhost);
    checkCollisions();
  }
  draw();
  requestAnimationFrame(loop);
}

/* ===== IN√çCIO ===== */
setupLevel();
loop();
</script>

</body>
</html>
